# Deep Dive into Stability AI's Generative Models - Stable Diffusion Turbo and Adversarial Diffusion Distillation

![add-title.png](images%2Fadd-title.png)

ðŸ”— https://arxiv.org/abs/2311.17042

_Adversarial Diffusion Distillation (ADD)_ is a cutting-edge framework designed to significantly boost the inference speed of large-scale diffusion models, which are renowned for generating high-fidelity images but are hampered by slow sampling rates due to their iterative nature. ADD achieves this acceleration by condensing the knowledge from a pre-trained, computationally intensive teacher diffusion model into a streamlined student model. This student model is then capable of producing images of comparable quality in a fraction of the steps required by its predecessor.

The core mechanism of ADD involves a few pivotal components and processes. It starts with the Teacher Model, a high-capacity diffusion model that has been trained to generate exceptionally high-quality images and serves as the primary source of knowledge. The Student Model, in contrast, is a smaller and more computationally efficient diffusion model that is designed to learn under the teacher model's guidance. The process of Forward Diffusion involves incrementally adding noise to a real image over multiple timesteps, gradually degrading it. During Distillation, the student model is trained to partially reverse this process, learning to predict intermediate states that are less noisy with fewer reverse diffusion steps. Adversarial Training introduces a discriminator network tasked with distinguishing between images generated by the student and those by the teacher. This element of competition encourages the student model to develop efficient methods for quickly generating realistic, high-quality images.

The advantages of ADD are notable, particularly in terms of Inference Speed, where it enables the development of diffusion models capable of near-instant image synthesis. This improvement opens up new possibilities for their application in interactive and time-sensitive scenarios. Additionally, the Computational Efficiency achieved through the smaller size of ADD-trained student models leads to a reduced memory footprint and lower computational requirements, making these advanced models more accessible.

However, there are considerations to bear in mind. The Quality-Speed Trade-off means that while student models generally maintain excellent image quality, there may be minor fidelity differences compared to the teacher models. Furthermore, the Framework Complexity is heightened due to the inclusion of an adversarial training regime, adding layers of complexity to the ADD training process compared to traditional diffusion model training approaches.

## In Simple Terms

Let's look at Adversarial Diffusion Distillation (ADD) in simpler terms. 

Think of it like teaching a new artist (the ADD model) to paint pictures really quickly by learning from a more experienced artist (the pretrained diffusion model).

The experienced artist has been around for a while and knows how to create beautiful, detailed paintings (high-quality images), but they take a long time to finish each piece. Now, we want the new artist to make paintings that are just as nice but much faster.

To do this, the new artist learns in two main ways:

1. **Adversarial Learning**: This is like a quick art contest. The new artist tries to create a painting, and a judge (the discriminator) tries to decide whether it's a real painting they would see in a gallery or a fast, made-up one. If the judge can't tell the difference, the new artist is doing a great job.

2. **Score Distillation**: Meanwhile, the new artist also keeps learning from the experienced one. They look at how the experienced artist would start adding details to a painting at different stages and try to copy that. The idea is to capture the essence of the detailed work but do it much faster.

By combining these two learning methods, the new artist quickly gets better at making paintings that look almost as good as the experienced artist's but in just a few brush strokes.

In the tech world, this translates to ADD being a method that lets an image generation model (like one that makes images from text descriptions) produce high-quality images in just a few steps, making it much faster than older methods. This speed-up could allow for new real-time applications, like instant visualizations for virtual reality or quick image edits on the fly.

## Prerequisites

Let's look at GANs and Latent Consistency Models (LCMs) before we delve into how ADD uses them.

**Distillation**: 
Distillation is a technique used to transfer knowledge from a larger, more complex model (teacher) to a smaller, simpler model (student). The goal is to retain the performance benefits of the larger model while reducing the computational cost and increasing the efficiency of the smaller model. This is especially valuable for deploying models to environments where resources are limited, like mobile devices.

**Generative Adversarial Networks (GANs)**:
Imagine two people: one is a forger trying to create a perfect copy of a famous painting, and the other is an art critic trying to spot the fake. The forger keeps making better forgeries based on the criticâ€™s feedback until the critic canâ€™t tell the difference between the fake and the real painting. In the digital world, GANs work similarly. They consist of two neural networks:

- The **Generator**: This network generates new images from random noise, trying to create data that looks like it could have come from the real dataset (like the forger).
- The **Discriminator**: This network tries to distinguish between the real data and the fake data produced by the generator (like the art critic).

They are trained together in a competitive game: the generator is getting better at creating images, and the discriminator is getting better at telling them apart. The end goal is for the generator to produce images that are indistinguishable from real ones.

![cm-figure1.png](images%2Fcm-figure1.png)

**Consistency Models (CMs)**:
Consistency Models are a type of generative model that is designed for generating images in just one or a few steps. The central idea of a CM is to learn a function that can predict the 'origin' of a trajectory in a special mathematical space defined by the model's equations. This means that instead of taking many small steps to generate an image (like walking step-by-step from one end of a park to the other), CMs try to make a big leap directly to the destination. They are called 'consistency' models because they aim to ensure that this leap lands at the correct spot every time, which would be consistent with the model's understanding of the image space.

Song, Y., Dhariwal, P., Chen, M., & Sutskever, I. (2023). Consistency Models. https://arxiv.org/abs/2303.01469

![lcm-figure1.png](images%2Flcm-figure1.png)

**Latent Consistency Models (LCMs)**:
Latent Consistency Models are an advancement of Consistency Models. They work in what's called a 'latent space', which is a simplified representation of data. It's like having a complex idea in your head (high-resolution image) but explaining it with just a simple sentence (latent representation). LCMs use this approach to quickly generate high-quality images, often with just one or a few steps of computation. This is much faster compared to other models that might need many steps to generate images.

Simian Luo, Yiqin Tan, Longbo Huang, Jian Li, Hang Zhao. (2023). Latent Consistency Models: Synthesizing High-Resolution Images with Few-Step Inference
https://arxiv.org/abs/2310.04378

**How ADD Uses GANs and LCMs**:
ADD combines the best of both worlds. From GANs, it borrows the adversarial training method, which is great at ensuring the images look real and are high quality. From LCMs, it borrows the idea of working with a compressed (latent) representation, which can be manipulated quickly and efficiently.

In essence, ADD uses the adversarial approach to fine-tune the details and make the images look realistic, while using the principles of consistency from LCMs to ensure that the images make sense when generated quickly from a compressed version. This blend allows ADD to generate high-quality images fast, in just a few steps, which is a huge advantage over the slower methods of traditional GANs and LCMs.

## Deep Dive - The Paper

ðŸ”— https://arxiv.org/abs/2311.17042

Axel Sauer, Dominik Lorenz, Andreas Blattmann, Robin Rombach. (2023). Adversarial Diffusion Distillation

A groundbreaking approach known as Adversarial Diffusion Distillation (ADD) was developed by the minds at Stability AI. This method is a leap forward in how we can quickly generate high-quality images from foundational diffusion models, doing so in an incredibly short 1â€“4 steps.

At the core of ADD is a clever process called score distillation. This allows researchers to harness the power of existing, large-scale image diffusion models as a guide for teaching. By integrating this with an adversarial loss, they ensure the generated images remain true to life, a crucial factor when working with as few as one or two steps.

ADD outperforms other methods designed for quick image creation, like GANs and Latent Consistency Models, even in its first step. It even rivals the capabilities of top-tier diffusion models such as SDXL by the fourth step. Impressively, ADD introduces the ability for real-time, single-step image synthesis using foundational modelsâ€”a potential game-changer in how we create and interact with images.

Our exploration aims to illuminate how ADD could transform both theoretical research and practical applications, making advanced image generation more accessible and efficient.

## In a Nutshell

The primary goal of this research is set forth as an ambitious blend: to combine the high-quality outputs of DMs with the rapid generation capabilities of GANs. The researchers introduce a clever solution, Adversarial Diffusion Distillation (ADD), which remarkably reduces the sampling steps required by a pre-trained diffusion model to a mere 1â€“4 steps without sacrificing the quality of the output. This approach uses a dual training objective that combines adversarial loss with distillation loss, specifically through _score distillation sampling (SDS)_. The adversarial loss ensures the generated samples closely mirror the quality of real images, avoiding common issues like blurriness found in other distillation techniques. Meanwhile, the distillation loss utilizes a pre-trained DM as a 'teacher,' drawing upon its extensive knowledge to preserve the detailed compositional qualities found in large DMs. Notably, this method does away with classifier-free guidance during inference, reducing memory usage and retaining the model's ability to refine iteratively, setting it apart from previous one-step GAN approaches.

![figure2.png](images%2Ffigure2.png)

The researchers summarize the key contributions of their work with precision:
- The unveiling of ADD as a groundbreaking method enabling pre-trained diffusion models to serve as high-quality, real-time image generators with just 1â€“4 sampling steps.
- The innovative integration of adversarial training with score distillation, along with a thorough exploration of design choices.
- ADD's exceptional performance against robust baselines, including LCM, LCM-XL, and single-step GANs, demonstrating its prowess in managing complex image compositions while delivering high realism in just one inference step.
- The development of ADD-XL, which outperforms the teacher model, SDXL-Base, at a resolution of 512x512 pixels with only four sampling steps.

## Background

Let's dive into the challenges and progresses that paved the way for this innovative technique, as illustrated in the research figures.

Diffusion models (DMs) in crafting and modifying high-quality images and videos are impressive. However, the iterative nature of their sampling process poses a significant hurdle for real-time applications. Latent diffusion models offer a workaround by operating in a more manageable latent space, but they still lean on the iterative use of bulky, parameter-rich models. Efforts to accelerate this process have led to the development of quicker samplers and model distillation strategies like progressive and guidance distillation aimed at cutting down the sampling steps. Despite these efforts, performance often dips, and the iterative nature of training persists.

Latent Consistency Models (LCMs) tackle some of these issues through consistency regularization, achieving notable results with fewer sampling steps. Techniques such as LCM-LoRA show the effectiveness of low-rank adaptation training in refining LCMs, and InstaFlow introduces Rectified Flows for enhanced distillation. Yet, a common challenge remains: the blurriness and artifacts in images generated in a reduced number of steps, a problem that intensifies with fewer steps.

![figure3.png](images%2Ffigure3.png)

The figures in the research vividly compare the performance of cutting-edge fast samplers, including ADD-XL and LCM-XL models, across different sampling steps. These comparisons reveal how the ADD model preserves image quality even with fewer steps, surpassing other quick samplers.

While Generative Adversarial Networks (GANs) excel in speed with their single-step sampling, they don't quite match the quality of diffusion-based models. This shortfall is partly due to the intricate balance needed in GAN architectures for stable training, along with the lack of mechanisms such as classifier-free guidance that benefit DMs at scale.

Score Distillation Sampling (SDS), or Score Jacobian Chaining, stands out as a promising approach to imbue 3D synthesis models with the knowledge from foundational Text-to-Image (T2I) Models. Initially aimed at optimizing individual 3D objects, its use has expanded to text-to-3D-video synthesis and image editing.

Recent advancements have underscored a significant link between score-based models and GANs, leading to creations like Score GANs that utilize score-based diffusion flows from a DM instead of using a discriminator. Techniques such as DiffInstruct expand SDS's application, enabling the distillation of a pre-trained DM into a generator without necessitating a discriminator.

There are also endeavors to refine the diffusion process with adversarial training, like Denoising Diffusion GANs and Adversarial Score Matching, where discriminator loss is used to boost quality in fewer steps.

![figure8.png](images%2Ffigure8.png)

ADD employs a dual strategy of adversarial training and score distillation to overcome the limitations faced by the leading few-step generative models of today. The visuals underscore ADD's capacity to preserve clarity and realism in images, tackling the prevalent issues of blurriness and artifacts in rapid sampling techniques. Through this blended method, the authors seek to find a sweet spot between speed and quality, thereby establishing a new standard for real-time generative modeling.

## Methodology

In the methodology section, the researchers unfold their strategy for generating high-fidelity images with minimal steps, aiming to match the quality of leading models in the field. They acknowledge the rapid sample generation of adversarial objectives directly within the image manifold but also recognize the scaling challenges of GANs, especially in improving text alignment with large datasets. To avoid the artifacts and quality loss typically seen with discriminative networks, they suggest using the gradients of a pretrained diffusion model through a score distillation objective. By starting with weights from a pretrained diffusion model, they tap into the proven benefits of pretraining for adversarial loss training. Differing from the decoder-only architecture commonly used in GAN training, they opt for a standard diffusion model framework that naturally supports iterative image refinement.

The training process involves three networks: the ADD-student, a discriminator, and a DM teacher. The ADD-student, built on a pretrained UNet-DM, creates samples from noisy inputs, which are then evaluated by the discriminator against real images. This discriminator, refined with lightweight, trainable heads, also considers additional data like text or image embeddings to enhance sample quality. They use hinge loss for the adversarial objective to train the ADD-student, while the discriminator seeks to minimize its own hinge loss, enhanced with an R1 gradient penalty for better performance at higher resolutions.

The core objective merges adversarial loss with distillation loss. The latter is crucial for leveraging the pretrained diffusion model's knowledge to guide the ADD-student. They argue that combining student samples with the teacher's forward process for the distillation target yields more stable gradients, especially for latent diffusion models.

![formula1.png](images%2Fformula1.png)

![formula2.png](images%2Fformula2.png)

![formula3.png](images%2Fformula3.png)

Formulas (1), (2), and (3) detail the adversarial and distillation losses forming the hybrid training objective. This balance aims for sample realism and retains the integrity of the pretrained model's knowledge, ensuring rapid, high-fidelity sample generation for real-time applications. This methodology represents a nuanced blend of adversarial training and score distillation, designed to overcome the limitations of current few-step generative models.

![formula4.png](images%2Fformula4.png)

The distillation loss (Equation 1) uses a distance metric `d` to compare the ADD-student's samples `x_Î¸` against the DM-teacher's outputs, calculating this over various timesteps `t` and noise instances `Ïµâ€²`. The teacher model applies to diffused outputs rather than the ADD-student's direct outputs, avoiding out-of-distribution issues.

They explore two weighting functions for `c(t)`: exponential weighting, which assigns lower weight to higher noise levels, and score distillation sampling (SDS) weighting, aligning the distillation loss with the SDS objective `L_SDS` from prior studies. This formulation enables direct visualization of reconstruction targets and integrates multiple denoising steps naturally. They also investigate noise-free score distillation (NFSD) for its potential benefits.

Their experiments involve two models, ADD-M with 860 million parameters and ADD-XL with 3.1 billion parameters, using a Stable Diffusion (SD) 2.1 backbone for ADD-M and comparing it to other models like SD1.5. ADD-XL is based on an SDXL backbone, with all experiments conducted at 512x512 pixels.

A distillation weighting factor (Î») of 2.5 and an R1 penalty strength (Î³) of 10^-5 are used uniformly. Discriminator conditioning employs a pretrained CLIP-ViT-g-14 text encoder and a DINOv2 ViT-L encoder for text and image embeddings, respectively. The study includes benchmarks against public domain models, using FrÃ©chet Inception Distance (FID) and CLIP score for evaluation.

The ablation study examines various configurations, revealing insights like the superiority of DINOv2 for discriminator networks and the effectiveness of combining text and image conditioning. It highlights the importance of pretrained generators, the impact of different loss terms on sample diversity and text alignment, and the influence of teacher model choice on student performance.

_An ablation study is a research methodology used primarily in the fields of computer science and neuroscience, among others, to assess the impact of various components of a system or model. In the context of machine learning and artificial intelligence, an ablation study involves systematically removing or "ablating" parts of an algorithm or model (such as layers in a neural network, features from a dataset, or specific parameters) to understand their contribution to the model's performance. By comparing the performance of the original model with that of the ablated versions, researchers can identify which components are crucial for the model's effectiveness, which are redundant, and how different elements interact. This process helps in understanding the model's behavior, simplifying complex models, and guiding future improvements._

![figure6.png](images%2Ffigure6.png)

Quantitative comparisons favor user preference studies over automated metrics for a comprehensive assessment, with ADD-XL showing iterative refinement advantages over GAN-based methods. User studies confirm ADD-XL's superior quality and prompt adherence, despite a minor compromise in diversity. The supplementary material offers additional samples and comparisons, underscoring the ADD approach's effectiveness in few-step sampling and distillation methods.

## Conclusion

As we wrap up our exploration, it's clear that the groundbreaking work on Adversarial Diffusion Distillation (ADD) marks a significant milestone in the field of generative modeling. The authors have skillfully woven together an adversarial objective with score distillation, leveraging the strengths of both the discriminator's real-world insights and the diffusion teacher's structural guidance. This blend has proven especially potent for rapid image generation, setting new benchmarks for efficiency by producing high-quality images in as few as one or two steps.

![figure7.png](images%2Ffigure7.png)

Furthermore, ADD distinguishes itself by not just excelling in swift image creation but also offering the flexibility for enhancement through additional iterative steps. Impressively, by employing just four steps, ADD outpaces traditional multi-step generators like SDXL, IF, and OpenMUSE, establishing a new standard in image synthesis.

The introduction of ADD opens up thrilling prospects for real-time image generation using foundational models, promising to transform the landscape of generative models across a spectrum of applications. This innovation not only boosts the efficiency of image generation processes but also broadens their practicality in real-world settings, heralding a future where high-fidelity image generation is both rapid and accessible.

## Personal Notes

![lcm-demo-cwk.png](images%2Flcm-demo-cwk.png)

Diving into LCM for the first time, I was genuinely astonished at its capability to churn out high-quality images with such speed. It's a testament to the rapid pace at which the AI domain is evolving. The landscape changes not just yearly but monthly, weekly, even daily, with each new innovation and breakthrough. It's an exhilarating era to be a part of this field.

I feel a deep sense of gratitude towards the trailblazers at the forefront of these advancements. Their relentless pursuit of the uncharted and their dedication to pushing the limits of the possible are what bring the future into our present.

A special shoutout to Stability AI for their remarkable contributions to the AI and generative model sectors, generously sharing their breakthroughs as open source. Their work is not just pioneering but also pivotal in shaping the trajectory of artificial intelligence.